<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        #micIcon {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 3em;
            z-index: 100;
        }

        #Text_Content, # Text_View{
            display: none;
        }

        #stop, #play{
            display: none;
        }

    </style>
</head>
<body>
    <div>
    {% if 'user' in session %}
    <li><h3 class="display-4" style="color: #3366FF; display: inline;"><span>{{message}}</span></h3><h1 style="display: inline; color: #f03699;"> ë‹˜ ë°˜ê°‘ìŠµë‹ˆë‹¤ !</h1></li>
    {% endif %}
    </div>
    <div>
        <form action = '/record/start' method="POST">
            <button id="record">ë…¹ìŒ ì‹œì‘</button>
            <button id="stop">ë…¹ìŒ ì¤‘ì§€</button>
            <buttom id="play">ìŒì„± ì¬ìƒ</button>
        </form>
        <!-- ë…¹ìŒëœ ìŒì„±íŒŒì¼ ë‹¤ìš´ë¡œë“œ ë§í¬ ì¶”ê°€ -->
        <form action="/record/download" method="POST" id="downloadForm" style="display: none;">
            <button type="submit">{{user_name}}ë‹˜ì˜ ë…¹ìŒë³¸ ë‹¤ìš´ë¡œë“œ</button>
        </form>
    </div>
    
    <div id="Text_View" style = "width: 500px; margin: 0 auto; font-size: 24px;">
        content
        <div id ="Text_Content" style="border: 2px solid #000; width: 500px; height: 300px;  margin: 0 auto;">
        
        </div>
    </div>

    <!-- ë§ˆì´í¬ ì•„ì´ì½˜ ì¶”ê°€ -->
    <i id="micIcon">ğŸ™ï¸</i>

    <div>
        <button onclick="location.href='/'">Home</button>
    </div>
</body>
</html>

<script>
    var mediaRecorder;
    var audioChunks = [];
    var audioBlob;
    
    navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
            mediaRecorder = new MediaRecorder(stream);
    
            mediaRecorder.addEventListener("dataavailable", event => {
                audioChunks.push(event.data);
            });
    
            var record = document.getElementById('record');
            var stop = document.getElementById('stop');
            var play = document.getElementById('play');

            var Text_View = document.getElementById('Text_View');
            var Text_Content = document.getElementById('Text_Content');

    
            record.addEventListener('click', function(event){
                event.preventDefault();
                audioChunks = [];
                mediaRecorder.start();
                this.style.display = 'none';
                stop.style.display = 'inline-block';
            });
            
            stop.addEventListener('click', function(event){
                event.preventDefault();
                audioChunks = [];
                mediaRecorder.stop();
                this.style.display ='none';
                record.style.display ='none';
                play.style.display = 'inline-block';

                audioBlob = new Blob(audioChunks, {type: 'audio/wav'};
                const formData = new FormData();
                formData.append("audio", audioBlob);

                fetch('/record/tts', {
                    
                })
            });


                    mediaRecorder.stop();
                    this.innerText = 'ë…¹ìŒ ì‹œì‘';
                    this.style.display = 'none';  // ë…¹ìŒ ë²„íŠ¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
                    playbackButton.style.display = 'block';  // ì¬ìƒ ë²„íŠ¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
    
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    const formData = new FormData();
                    formData.append("audio", audioBlob);
    
                    fetch('/record/start', {
                        method: "POST",
                        body: formData
                    }).then(response => response.text())
                      .then(text => {
                        textView.innerText = text;  // ë°›ì€ í…ìŠ¤íŠ¸ë¥¼ í‘œì‹œí•©ë‹ˆë‹¤.
                      });
                }
            });
    
            playbackButton.addEventListener('click', function(event){
                event.preventDefault();
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
    
                this.style.display = 'none';  // ì¬ìƒ ë²„íŠ¼ì„ ìˆ¨ê¹ë‹ˆë‹¤.
                recordButton.style.display = 'block';  // ë…¹ìŒ ë²„íŠ¼ì„ ë³´ì—¬ì¤ë‹ˆë‹¤.
            });
        });
</script>


<!--
<script>

    navigator.mediaDevices.getUserMedia({ audio: true })
    .then(stream => {
        const mediaRecorder = new MediaRecorder(stream);
        var audioChunks = [];
        let ttsText = "";

        var stop_recording = false; // ë…¹ìŒ ì¤‘ì§€ ìƒíƒœ ë³€ìˆ˜
        document.getElementById('recordButton').addEventListener('click', function(){
            event.preventDefault(); //ë¸Œë¼ìš°ì €ì˜ ê¸°ë³¸ë™ì‘(í˜ì´ì§€ ë™ì‘ ë“±)ì„ ë§‰ê¸°
            if(this.innerText ==='ë…¹ìŒ ì‹œì‘'){
                this.innerText = 'ë…¹ìŒ ì¤‘ì§€';
                stop_recording = false; // ë…¹ìŒ ì‹œì‘
                mediaRecorder.start(); // ë…¹ìŒì‹œì‘

                //ë…¹ìŒ ì‹œì‘ ì‹œ ë§ˆì´í¬ ì•„ì´ì½˜ ë³´ì´ê¸°
                micIcon.style.display = 'inline-block';
            }else if(this.innerText ==='ë…¹ìŒ ì¤‘ì§€'){
                this.innerText =' ìŒì„± ì¬ìƒ';
                stop_recording = true; // ë…¹ìŒ ì¤‘ì§€
                mediaRecorder.stop();

                // ë…¹ìŒ ì¤‘ì§€ ì‹œ ë§ˆì´í¬ ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
                micIcon.style.display = 'none';

                // ë…¹ìŒì´ ì¤‘ì§€ë  ë•Œ, 'Text View'ë¥¼ ë³´ì—¬ì§€ë„ë¡ ìˆ˜ì •
                var contentDiv = document.createElement('div');
                contentDiv.style.width = '500px';
                contentDiv.style.margin = '0 auto';
                contentDiv.style.fontSize = '24 px';
                contentDiv.innerHTML = 'content';

                var textView = document.createElement('div');
                textViewDiv.id = 'Text_View';
                textViewDiv.style.display = 'block';
                textViewDiv.style.border = '2px solid #000';
                textViewDiv.style.width = '500px';
                textViewDiv.style.height = '300px';
                textViewDiv.style.margin = '0 auto';

                contentDiv.appendChild(textViewDiv);
                document.body.appendChild(contentDiv);

            }else{
                this.innerText = 'ë…¹ìŒ ì‹œì‘';
            // TTS ìš”ì²­
            fetch('/record/tts', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({text: ttsText})
            });
        }
    });

        mediaRecorder.addEventListener("dataavailable", function(event) {
            audioChunks.push(event.data);
        });

        mediaRecorder.addEventListener("stop", function() {
            const audioBlob = new Blob(audioChunks, {
                type: 'audio/wav'
            });
            const formData = new FormData();    
            formData.append("audio", audioBlob);
            fetch('/record/start', {
                method: "POST",
                body: formData
            }).then(response => response.text())
              .then(text => {
                    ttsText = text;

                    //ì„œë²„ì—ì„œ ë°˜í™˜í•œ í…ìŠ¤íŠ¸ë¥¼ 'Text_View' div íƒœê·¸ì— ì¶œë ¥
                    document.getElementById('Text_View').innerText = ttsText;

                    // 'Text_View' divì™€ ê·¸ ë¶€ëª¨ divë¥¼ í™”ë©´ì— ë³´ì—¬ì£¼ê¸°
                    var contentView = document.querySelector('#Text_View').parentNode;
                    contentView.style.display = 'block';
                    
                    //ë…¹ìŒì´ ì™„ë£Œë˜ë©´ ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ í‘œì‹œ
                    document.getElementById('downloadForm').style.display = 'block';
              });
            audioChunks = [];
        });
    });
</script>
-->